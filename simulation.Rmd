---
title: "COVID simulation"
output: html_notebook
---

```{r}
source("simulation.R")
library(pracma)
```

Simulation parameters

```{r}
t <- 1:200

# Hospital parameters
beds_per_1000pop <- 5
hospitalisation_rate <- 0.15

parameters_baseline <- c(
  mu = 0, 
  beta = 1.75,
  sigma = 1 / 5, # 1 / mean incubation time?
  gamma = 0.5
)

parameters_distancing <- c(
  mu = 0, 
  beta = 1.75 / 2,
  sigma = 1 / 5, # 1 / mean incubation time?
  gamma = 0.5
)

initials <- c(
  S = 1 - 1/1E4, 
  E = 1/1E4, 
  I = 0, 
  R = 0
)

seir_baseline <- SEIR(
  pars = parameters_baseline, 
  init = initials, 
  time = t
)

seir_distancing <- SEIR(
  pars = parameters_distancing, 
  init = initials, 
  time = t
)
```

```{r}
baseline <- seir_baseline$results %>% 
  mutate(
    needs_hosp = I * hospitalisation_rate,
    treated = pmin(beds_per_1000pop / 1E3, needs_hosp),
    untreated = needs_hosp - treated
  )

distancing <- seir_distancing$results %>% 
  mutate(
    needs_hosp = I * hospitalisation_rate,
    treated = pmin(beds_per_1000pop / 1E3, needs_hosp),
    untreated = needs_hosp - treated
  )

baseline
```

```{r}
distancing
```

```{r, fig.width = 4}
p_data <- bind_rows(
  seir_baseline$results %>% 
    mutate(scenario = "baseline"),
  seir_distancing$results %>% 
    mutate(scenario = "distancing")
)

p <- ggplot(p_data, aes(x = time, y = I, colour = scenario)) +
  geom_line()

p
```

Initialise matrices

```{r}
set.seed(1)
p_size <- 100 * 100
matrices <- init_matrices(p_size, nrow = 100, ncol = 100, e0 = 100)
```


```{r}
plot_matrix(matrices$i)
```

```{r}
states_baseline <- calc_state_frames(baseline, p_size)
states_baseline
```


```{r}
matrices <- init_matrices(p_size, nrow = 100, ncol = 100, e0 = states_baseline[1, "E"])
infection_likelihood <- calc_exposure_likelihood(matrices$s, matrices$i, 10, 0.1)
```

```{r}
plot_matrix(infection_likelihood)
```



```{r}
set.seed(0)
matrices <- init_matrices(p_size, nrow = 100, ncol = 100, e0 = states_baseline[1, "E"])
for (i in seq_len(38)) {
  # browser()
  cat(paste0(i, " "))
  matrices <- update_matrices(
    matrices$s,
    matrices$e,
    matrices$i,
    matrices$r,
    states_baseline[i + 1, ]
  )
}
```

```{r}
p_mat <- gen_visual_matrix(
  matrices$s,
  matrices$e,
  matrices$i,
  matrices$r
)
```


```{r}
p <- plot_matrix(p_mat)

p + scale_fill_manual(
  values = c(
    "S" = "#D9D1D6", 
    "E" = "#FFEE93", 
    "I" = "#FF6b6b",
    "R" = "#454545"
  )
)
```



